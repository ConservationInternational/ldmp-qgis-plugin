sudo: required
services:
- docker
env:
  global:
  - PLUGIN_NAME=LDMP
  matrix:
  - QGIS_VERSION_TAG=master_2 PYTHON_EXECUTABLE=python PIP_EXECUTABLE=pip
before_install:
- openssl aes-256-cbc -K $encrypted_e3ee5199e171_key -iv $encrypted_e3ee5199e171_iv
  -in travis_secrets.tar.gz.enc -out travis_secrets.tar.gz -d
- tar xzvf travis_secrets.tar.gz
- mv trends.earth_test_user_credentials.json LDMP/test/trends.earth_test_user_credentials.json
- mv trends.earth_admin_user_credentials.json LDMP/test/trends.earth_admin_user_credentials.json
- git clone https://github.com/boundlessgeo/qgis-testing-environment-docker qgis-testing-environment
- cd qgis-testing-environment && docker build -t qgis-testing-environment 
  --build-arg QGIS_BRANCH=$QGIS_VERSION_TAG --build-arg LEGACY='true' .
- docker run -d --name qgis-testing-environment
  -v ${TRAVIS_BUILD_DIR}:/tests_directory -e DISPLAY=:99
  elpaso/qgis-testing-environment
- sleep 10
- docker exec -it qgis-testing-environment sh -c "qgis_setup.sh ${PLUGIN_NAME}"
- docker exec -it qgis-testing-environment sh -c "pip install paver"
- docker exec -it qgis-testing-environment sh -c "pip install boto3"
script:
- export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH;
  else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
- echo "TRAVIS_BRANCH=$TRAVIS_BRANCH, PR=$PR, BRANCH=$BRANCH"
- docker-compose exec qgis-testing-environment sh -c "cd /tests_directory && paver
  setup && paver package --tests"
- docker version
- docker exec -it qgis-testing-environment sh -c "qgis_testrunner.sh LDMP.test.dialog_settings_tests.run_all"
after_success:
- |
  if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
      docker exec -it qgis-testing-environment sh -c "cd /tests_directory && paver deploy"
  fi
